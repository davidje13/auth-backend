{"version":3,"sources":["webpack://auth-backend/webpack/universalModuleDefinition","webpack://auth-backend/webpack/bootstrap","webpack://auth-backend/external \"express\"","webpack://auth-backend/external \"node-fetch\"","webpack://auth-backend/external \"jwt-simple\"","webpack://auth-backend/external \"crypto\"","webpack://auth-backend/external \"uuid\"","webpack://auth-backend/./src/providers/GoogleSso.ts","webpack://auth-backend/./src/providers/GitHubSso.ts","webpack://auth-backend/./src/AuthenticationService.ts","webpack://auth-backend/./src/router.ts","webpack://auth-backend/./src/mock-sso/authContent.ts","webpack://auth-backend/./src/mock-sso/buildMockSsoApp.ts","webpack://auth-backend/./src/index.ts"],"names":["root","factory","exports","module","define","amd","global","installedModules","__webpack_require__","moduleId","i","l","modules","call","m","c","d","name","getter","o","Object","defineProperty","enumerable","get","r","Symbol","toStringTag","value","t","mode","__esModule","ns","create","key","bind","n","object","property","prototype","hasOwnProperty","p","s","require","async","extractId","config","externalToken","params","URLSearchParams","append","res","fetch","tokenInfoUrl","toString","status","Error","externalTokenInfo","json","error","aud","clientId","sub","accessParams","clientSecret","accessRes","accessTokenUrl","method","headers","body","accessResults","text","accessToken","userRes","userUrl","Authorization","id","AuthenticationService","constructor","configs","Map","this","bindExtractor","extractGoogleId","extractGitHubId","supportsService","service","extractors","has","extractor","set","clientConfig","authUrl","JSON_BODY","express","limit","buildAuthenticationRouter","authenticationService","tokenGranter","router","Router","req","post","next","externalId","userToken","e","message","htmlSafe","replace","query","keys","crypto","generateKeyPairSync","modulusLength","privateKeyEncoding","type","format","publicKeyEncoding","app","header","send","redirect_uri","nonce","state","client_id","urlencoded","extended","redirectUri","identifier","now","Math","floor","Date","idToken","jwt","encode","jti","uuidv4","iat","exp","privateKey","redirectParams","redirect","id_token","decode","publicKey","buildAuthenticationBackend"],"mappings":"CAAA,SAA2CA,EAAMC,GAC1B,iBAAZC,SAA0C,iBAAXC,OACxCA,OAAOD,QAAUD,IACQ,mBAAXG,QAAyBA,OAAOC,IAC9CD,OAAO,eAAgB,GAAIH,GACD,iBAAZC,QACdA,QAAQ,gBAAkBD,IAE1BD,EAAK,gBAAkBC,IARzB,CASGK,QAAQ,WACX,O,YCTE,IAAIC,EAAmB,GAGvB,SAASC,EAAoBC,GAG5B,GAAGF,EAAiBE,GACnB,OAAOF,EAAiBE,GAAUP,QAGnC,IAAIC,EAASI,EAAiBE,GAAY,CACzCC,EAAGD,EACHE,GAAG,EACHT,QAAS,IAUV,OANAU,EAAQH,GAAUI,KAAKV,EAAOD,QAASC,EAAQA,EAAOD,QAASM,GAG/DL,EAAOQ,GAAI,EAGJR,EAAOD,QA0Df,OArDAM,EAAoBM,EAAIF,EAGxBJ,EAAoBO,EAAIR,EAGxBC,EAAoBQ,EAAI,SAASd,EAASe,EAAMC,GAC3CV,EAAoBW,EAAEjB,EAASe,IAClCG,OAAOC,eAAenB,EAASe,EAAM,CAAEK,YAAY,EAAMC,IAAKL,KAKhEV,EAAoBgB,EAAI,SAAStB,GACX,oBAAXuB,QAA0BA,OAAOC,aAC1CN,OAAOC,eAAenB,EAASuB,OAAOC,YAAa,CAAEC,MAAO,WAE7DP,OAAOC,eAAenB,EAAS,aAAc,CAAEyB,OAAO,KAQvDnB,EAAoBoB,EAAI,SAASD,EAAOE,GAEvC,GADU,EAAPA,IAAUF,EAAQnB,EAAoBmB,IAC/B,EAAPE,EAAU,OAAOF,EACpB,GAAW,EAAPE,GAA8B,iBAAVF,GAAsBA,GAASA,EAAMG,WAAY,OAAOH,EAChF,IAAII,EAAKX,OAAOY,OAAO,MAGvB,GAFAxB,EAAoBgB,EAAEO,GACtBX,OAAOC,eAAeU,EAAI,UAAW,CAAET,YAAY,EAAMK,MAAOA,IACtD,EAAPE,GAA4B,iBAATF,EAAmB,IAAI,IAAIM,KAAON,EAAOnB,EAAoBQ,EAAEe,EAAIE,EAAK,SAASA,GAAO,OAAON,EAAMM,IAAQC,KAAK,KAAMD,IAC9I,OAAOF,GAIRvB,EAAoB2B,EAAI,SAAShC,GAChC,IAAIe,EAASf,GAAUA,EAAO2B,WAC7B,WAAwB,OAAO3B,EAAgB,SAC/C,WAA8B,OAAOA,GAEtC,OADAK,EAAoBQ,EAAEE,EAAQ,IAAKA,GAC5BA,GAIRV,EAAoBW,EAAI,SAASiB,EAAQC,GAAY,OAAOjB,OAAOkB,UAAUC,eAAe1B,KAAKuB,EAAQC,IAGzG7B,EAAoBgC,EAAI,GAIjBhC,EAAoBA,EAAoBiC,EAAI,G,gBClFrDtC,EAAOD,QAAUwC,QAAQ,Y,cCAzBvC,EAAOD,QAAUwC,QAAQ,e,cCAzBvC,EAAOD,QAAUwC,QAAQ,e,cCAzBvC,EAAOD,QAAUwC,QAAQ,W,cCAzBvC,EAAOD,QAAUwC,QAAQ,S,mTCQVC,eAAeC,EAC5BC,EACAC,GAKA,MAAMC,EAAS,IAAIC,gBACnBD,EAAOE,OAAO,WAAYH,GAE1B,MAAMI,QAAYC,IAAO,GAAEN,EAAOO,gBAAgBL,EAAOM,cAEzD,GAAIH,EAAII,QAAU,IAChB,MAAM,IAAIC,MAAM,6BAGlB,MAAMC,QAA0BN,EAAIO,OACpC,GAAmB,MAAfP,EAAII,QAAkBE,EAAkBE,MAC1C,MAAM,IAAIH,MAAO,qBAAoBC,EAAkBE,SAGzD,GAAIF,EAAkBG,MAAQd,EAAOe,SACnC,MAAM,IAAIL,MAAM,qBAMlB,OAAOC,EAAkBK,IC1BZlB,eAAeC,EAC5BC,EACAC,GAEA,MAAMgB,EAAe,IAAId,gBACzBc,EAAab,OAAO,OAAQH,GAC5BgB,EAAab,OAAO,YAAaJ,EAAOe,UACxCE,EAAab,OAAO,gBAAiBJ,EAAOkB,cAC5C,MAAMC,QAAkBb,IAAMN,EAAOoB,eAAgB,CACnDC,OAAQ,OACRC,QAAS,CAAE,eAAgB,qCAC3BC,KAAMN,EAAaT,aAGfgB,EAAgB,IAAIrB,sBAAsBgB,EAAUM,QAEpDZ,EAAQW,EAAc9C,IAAI,SAChC,GAAImC,EACF,MAAM,IAAIH,MAAO,qBAAoBG,KAGvC,MAAMa,EAAcF,EAAc9C,IAAI,gBACtC,IAAKgD,EACH,MAAM,IAAIhB,MAAM,6BAGlB,MAAMiB,QAAgBrB,IAAMN,EAAO4B,QAAS,CAC1CN,QAAS,CAAEO,cAAgB,UAASH,OAItC,aAD0BC,EAAQf,QACfkB,G,wHCvBN,MAAMC,EAKZC,YAAYC,GAA+C,sBAJA,IAIA,oBAFpC,IAAIC,KAGhCC,KAAKC,cAAcH,EAAS,SAAUI,GACtCF,KAAKC,cAAcH,EAAS,SAAUK,GAGjCC,gBAAgBC,GACrB,OAAOL,KAAKM,WAAWC,IAAIF,GAGtBzC,UACLyC,EACAvC,GAEA,MAAM0C,EAAYR,KAAKM,WAAW/D,IAAI8D,GAEtC,IAAKG,EACH,MAAM,IAAIjC,MAAO,0BAAyB8B,sBAG5C,OAAOG,EAAU1C,GAGXmC,cACNH,EACAO,EACAG,GAEA,MAAM3C,EAASiC,EAAQO,IACnBxC,aAAJ,EAAIA,EAAQe,YACVoB,KAAKM,WAAWG,IACdJ,EACAG,EAAUtD,KAAK,KAAMW,IAEvBmC,KAAKU,aAAaL,GAAW,CAC3BM,QAAS9C,EAAO8C,QAChB/B,SAAUf,EAAOe,Y,oBCvDzB,MAAMgC,EAAYC,IAAQpC,KAAK,CAAEqC,MAAO,OAIjC,SAASC,EACdC,EACAC,GAEA,MAAMC,EAASL,IAAQM,SAqCvB,OAnCAD,EAAO3E,IAAI,IAAK,CAAC6E,EAAKlD,KACpBA,EAAII,OAAO,KAAKG,KAAKuC,EAAsBN,gBAG7CQ,EAAOG,KAAK,SAAUT,EAAWjD,MAAOyD,EAAKlD,EAAKoD,KAChD,MAAM,KAAErF,GAASmF,EAAIrD,OAErB,IAAKiD,EAAsBZ,gBAAgBnE,GAEzC,YADAqF,IAIF,MAAM,cAAExD,GAAkBsD,EAAIhC,KAC9B,GAAKtB,GAA0C,iBAAlBA,EAK7B,IACE,MAAMyD,QAAmBP,EAAsBpD,UAAU3B,EAAM6B,GAC/D,IAAKyD,EACH,MAAM,IAAIhD,MAAM,yBAGlB,MAAMiD,EAAYP,EAAc,GAAEhF,KAAQsF,IAActF,EAAMsF,GAC9DrD,EAAII,OAAO,KAAKG,KAAK,CAAE+C,cACvB,MAAOC,GACW,8BAAdA,EAAEC,QACJxD,EAAII,OAAO,KAAKG,KAAK,CAAEC,MAAO,mBAE9BR,EAAII,OAAO,KAAKG,KAAK,CAAEC,MAAO+C,EAAEC,SAAW,uBAhB7CxD,EAAII,OAAO,KAAKG,KAAK,CAAEC,MAAO,gCAqB3BwC,E,2CChDT,SAASS,EAAShF,GAEhB,OAAKA,EAGEA,EACJiF,QAAQ,KAAM,SACdA,QAAQ,KAAM,QACdA,QAAQ,KAAM,QACdA,QAAQ,KAAM,UACdA,QAAQ,KAAM,UAPR,GAUKC,ICJD,OACb,MAAMC,EAAOC,IAAOC,oBAAoB,MAAO,CAC7CC,cAAe,KACfC,mBAAoB,CAAEC,KAAM,QAASC,OAAQ,OAC7CC,kBAAmB,CAAEF,KAAM,OAAQC,OAAQ,SAGvCE,EAAMzB,MA4CZ,OA1CAyB,EAAI/F,IAAI,QAAS,CAAC6E,EAAKlD,KDLT2D,MCMZ3D,EAAIqE,OAAO,eAAgB,aAAaC,KDNe,0pCAkDHb,GAlDxCE,ECM6CT,EAAIS,OD4CMY,qEACtBd,EAASE,EAAMa,8DACff,EAASE,EAAMc,kEACXhB,EAASE,EAAMe,2KC5ClEN,EAAIjB,KAAK,QAASR,IAAQgC,WAAW,CAAEC,UAAU,IAAU,CAAC1B,EAAKlD,KAC/D,MACEuE,aAAcM,EADV,MAEJL,EAFI,MAGJC,EACAC,UAAWhE,EAJP,WAKJoE,GACE5B,EAAIhC,KAEH2D,GAAgBnE,GAAaoE,GAChC9E,EAAII,OAAO,KAAKG,KAAK,CAAEC,MAAO,mBAGhC,MAAMuE,EAAMC,KAAKC,MAAMC,KAAKH,MAAQ,KAC9BI,EAAUC,IAAIC,OAAO,CACzB5E,IAAKC,EACL8D,QACAc,IAAKC,eACL5E,IAAKmE,EACLU,IAAKT,EACLU,IAAKV,EAAM,MACVnB,EAAK8B,WAAY,SAEdC,EAAiB,IAAI7F,gBAC3B6F,EAAepD,IAAI,WAAY4C,GAC/BQ,EAAepD,IAAI,QAASkC,GAC5BzE,EAAI4F,SAAS,IAAM,GAAEf,KAAec,EAAexF,gBAGrDiE,EAAI/F,IAAI,aAAc,CAAC6E,EAAKlD,KAC1B,MAAQ6F,SAAUV,GAAYjC,EAAIS,MAClC,IACE3D,EAAIO,KAAK6E,IAAIU,OAAOX,EAASvB,EAAKmC,WAAW,EAAO,UACpD,MAAOxC,GACPvD,EAAII,OAAO,KAAKG,KAAK,CAAEC,MAAO,0BAI3B4D,GChCF,SAAS4B,EACdpE,EACAmB,GAEA,MAAMZ,EAAU,IAAIT,EAAsBE,GAG1C,MAAO,CACLoB,OAHaH,EAA0BV,EAASY,GAIhDZ","file":"index.js","sourcesContent":["(function webpackUniversalModuleDefinition(root, factory) {\n\tif(typeof exports === 'object' && typeof module === 'object')\n\t\tmodule.exports = factory();\n\telse if(typeof define === 'function' && define.amd)\n\t\tdefine(\"auth-backend\", [], factory);\n\telse if(typeof exports === 'object')\n\t\texports[\"auth-backend\"] = factory();\n\telse\n\t\troot[\"auth-backend\"] = factory();\n})(global, function() {\nreturn "," \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 5);\n","module.exports = require(\"express\");","module.exports = require(\"node-fetch\");","module.exports = require(\"jwt-simple\");","module.exports = require(\"crypto\");","module.exports = require(\"uuid\");","import fetch from 'node-fetch';\n\nexport interface GoogleConfig {\n  clientId: string;\n  authUrl: string;\n  tokenInfoUrl: string;\n}\n\nexport default async function extractId(\n  config: GoogleConfig,\n  externalToken: string,\n): Promise<string> {\n  // These checks can be done locally\n  // see https://developers.google.com/identity/sign-in/web/backend-auth\n\n  const params = new URLSearchParams();\n  params.append('id_token', externalToken);\n  // POST does not work (despite being listed in Google's docs)\n  const res = await fetch(`${config.tokenInfoUrl}?${params.toString()}`);\n\n  if (res.status >= 500) {\n    throw new Error('validation internal error');\n  }\n\n  const externalTokenInfo = await res.json();\n  if (res.status !== 200 || externalTokenInfo.error) {\n    throw new Error(`validation error: ${externalTokenInfo.error}`);\n  }\n\n  if (externalTokenInfo.aud !== config.clientId) {\n    throw new Error('audience mismatch');\n  }\n\n  // TODO: use externalTokenInfo.jti nonce to prevent replay attacks\n  // (would need to store value at least until exp time)\n\n  return externalTokenInfo.sub;\n}\n","import fetch from 'node-fetch';\n\nexport interface GitHubConfig {\n  clientId: string;\n  authUrl: string;\n  clientSecret: string;\n  accessTokenUrl: string;\n  userUrl: string;\n}\n\nexport default async function extractId(\n  config: GitHubConfig,\n  externalToken: string,\n): Promise<string> {\n  const accessParams = new URLSearchParams();\n  accessParams.append('code', externalToken);\n  accessParams.append('client_id', config.clientId);\n  accessParams.append('client_secret', config.clientSecret);\n  const accessRes = await fetch(config.accessTokenUrl, {\n    method: 'POST',\n    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },\n    body: accessParams.toString(),\n  });\n\n  const accessResults = new URLSearchParams(await accessRes.text());\n\n  const error = accessResults.get('error');\n  if (error) {\n    throw new Error(`validation error: ${error}`);\n  }\n\n  const accessToken = accessResults.get('access_token');\n  if (!accessToken) {\n    throw new Error('validation internal error');\n  }\n\n  const userRes = await fetch(config.userUrl, {\n    headers: { Authorization: `Bearer ${accessToken}` },\n  });\n\n  const userResults = await userRes.json();\n  return userResults.id;\n}\n","import extractGoogleId, { GoogleConfig } from './providers/GoogleSso';\nimport extractGitHubId, { GitHubConfig } from './providers/GitHubSso';\n\ntype UnconfiguredExtractor<T> = (config: T, externalToken: string) => Promise<string>;\ntype ConfiguredExtractor = (externalToken: string) => Promise<string>;\n\ninterface ClientProperties {\n  authUrl: string;\n  clientId: string;\n}\n\nexport interface AuthenticationConfiguration {\n  google: GoogleConfig;\n  github: GitHubConfig;\n}\n\nexport type AuthenticationClientConfiguration = Record<string, ClientProperties>;\n\nexport default class AuthenticationService {\n  public readonly clientConfig: AuthenticationClientConfiguration = {};\n\n  private readonly extractors = new Map<string, ConfiguredExtractor>();\n\n  public constructor(configs: Partial<AuthenticationConfiguration>) {\n    this.bindExtractor(configs, 'google', extractGoogleId);\n    this.bindExtractor(configs, 'github', extractGitHubId);\n  }\n\n  public supportsService(service: string): boolean {\n    return this.extractors.has(service);\n  }\n\n  public extractId(\n    service: string,\n    externalToken: string,\n  ): Promise<string> {\n    const extractor = this.extractors.get(service);\n\n    if (!extractor) {\n      throw new Error(`Login integration with ${service} is not supported`);\n    }\n\n    return extractor(externalToken);\n  }\n\n  private bindExtractor<Service extends keyof AuthenticationConfiguration>(\n    configs: Partial<AuthenticationConfiguration>,\n    service: Service,\n    extractor: UnconfiguredExtractor<AuthenticationConfiguration[Service]>,\n  ): void {\n    const config = configs[service];\n    if (config?.clientId) {\n      this.extractors.set(\n        service,\n        extractor.bind(null, config as AuthenticationConfiguration[Service]),\n      );\n      this.clientConfig[service] = {\n        authUrl: config.authUrl,\n        clientId: config.clientId,\n      };\n    }\n  }\n}\n","import express from 'express';\nimport type AuthenticationService from './AuthenticationService';\n\nconst JSON_BODY = express.json({ limit: 4 * 1024 });\n\nexport type TokenGranter = (userId: string, service: string, externalId: string) => string;\n\nexport function buildAuthenticationRouter(\n  authenticationService: AuthenticationService,\n  tokenGranter: TokenGranter,\n): express.Router {\n  const router = express.Router();\n\n  router.get('/', (req, res) => {\n    res.status(200).json(authenticationService.clientConfig);\n  });\n\n  router.post('/:name', JSON_BODY, async (req, res, next) => {\n    const { name } = req.params;\n\n    if (!authenticationService.supportsService(name)) {\n      next();\n      return;\n    }\n\n    const { externalToken } = req.body;\n    if (!externalToken || typeof externalToken !== 'string') {\n      res.status(400).json({ error: 'no externalToken provided' });\n      return;\n    }\n\n    try {\n      const externalId = await authenticationService.extractId(name, externalToken);\n      if (!externalId) {\n        throw new Error('failed to get user ID');\n      }\n\n      const userToken = tokenGranter(`${name}-${externalId}`, name, externalId);\n      res.status(200).json({ userToken });\n    } catch (e) {\n      if (e.message === 'validation internal error') {\n        res.status(500).json({ error: 'internal error' });\n      } else {\n        res.status(400).json({ error: e.message || 'unknown error' });\n      }\n    }\n  });\n\n  return router;\n}\n","function htmlSafe(value?: string): string {\n  // Thanks, https://stackoverflow.com/a/6234804/1180785\n  if (!value) {\n    return '';\n  }\n  return value\n    .replace(/&/g, '&amp;')\n    .replace(/</g, '&lt;')\n    .replace(/>/g, '&gt;')\n    .replace(/\"/g, '&quot;')\n    .replace(/'/g, '&#039;');\n}\n\nexport default (query: Record<string, string>): string => `\n<html>\n  <head>\n    <title>Mock OAuth service</title>\n    <style>\n      body {\n        background: #EEEEEE;\n        font: 1em sans-serif;\n        margin: 0;\n        padding: 0;\n      }\n      form {\n        width: 400px;\n        max-width: calc(100% - 20px);\n        box-sizing: border-box;\n        margin: 50px auto;\n        padding: 15px;\n        background: #FFFFFF;\n      }\n      h1 {\n        margin: 0 0 20px;\n        text-align: center;\n      }\n      p {\n        font-size: 0.8em;\n        margin: 20px 0;\n      }\n      input[type=text] {\n        width: 200px;\n        font-size: 0.9em;\n        padding: 4px;\n        margin: 0 10px;\n      }\n      button {\n        font-size: 0.9em;\n        padding: 6px 12px;\n        border: none;\n        background: #008800;\n        color: #FFFFFF;\n        cursor: pointer;\n      }\n    </style>\n  </head>\n  <body>\n    <form method=\"POST\">\n      <h1>Mock OAuth service</h1>\n      <p>\n        This is a mock implementation of an OAuth server which is used\n        for local testing (including end-to-end automated tests).\n      </p>\n      <input type=\"hidden\" name=\"redirect_uri\" value=\"${htmlSafe(query.redirect_uri)}\" />\n      <input type=\"hidden\" name=\"nonce\" value=\"${htmlSafe(query.nonce)}\" />\n      <input type=\"hidden\" name=\"state\" value=\"${htmlSafe(query.state)}\" />\n      <input type=\"hidden\" name=\"client_id\" value=\"${htmlSafe(query.client_id)}\" />\n      <label>Sign in as <input type=\"text\" name=\"identifier\" required autofocus /></label><button>Sign in</button>\n    </form>\n  </body>\n</html>\n`;\n","import crypto from 'crypto';\nimport jwt from 'jwt-simple';\nimport express from 'express';\nimport { v4 as uuidv4 } from 'uuid';\nimport authContent from './authContent';\n\n// This is for local development and testing; it simulates a\n// Google sign in handshake.\n\nexport default (): express.Express => {\n  const keys = crypto.generateKeyPairSync('rsa', {\n    modulusLength: 2048,\n    privateKeyEncoding: { type: 'pkcs8', format: 'pem' },\n    publicKeyEncoding: { type: 'spki', format: 'pem' },\n  });\n\n  const app = express();\n\n  app.get('/auth', (req, res) => {\n    res.header('Content-Type', 'text/html').send(authContent(req.query));\n  });\n\n  app.post('/auth', express.urlencoded({ extended: false }), (req, res) => {\n    const {\n      redirect_uri: redirectUri,\n      nonce,\n      state,\n      client_id: clientId,\n      identifier,\n    } = req.body;\n\n    if (!redirectUri || !clientId || !identifier) {\n      res.status(400).json({ error: 'missing fields' });\n    }\n\n    const now = Math.floor(Date.now() / 1000);\n    const idToken = jwt.encode({\n      aud: clientId,\n      nonce,\n      jti: uuidv4(),\n      sub: identifier,\n      iat: now,\n      exp: now + 60 * 60,\n    }, keys.privateKey, 'RS256');\n\n    const redirectParams = new URLSearchParams();\n    redirectParams.set('id_token', idToken);\n    redirectParams.set('state', state);\n    res.redirect(303, `${redirectUri}#${redirectParams.toString()}`);\n  });\n\n  app.get('/tokeninfo', (req, res) => {\n    const { id_token: idToken } = req.query;\n    try {\n      res.json(jwt.decode(idToken, keys.publicKey, false, 'RS256'));\n    } catch (e) {\n      res.status(400).json({ error: 'validation failure' });\n    }\n  });\n\n  return app;\n};\n","import type express from 'express';\nimport AuthenticationService, {\n  AuthenticationConfiguration,\n  AuthenticationClientConfiguration,\n} from './AuthenticationService';\nimport {\n  TokenGranter,\n  buildAuthenticationRouter,\n} from './router';\nimport buildMockSsoApp from './mock-sso/buildMockSsoApp';\n\ninterface AuthenticationBackend {\n  router: express.Router;\n  service: AuthenticationService;\n}\n\nexport type {\n  TokenGranter,\n  AuthenticationConfiguration,\n  AuthenticationClientConfiguration,\n};\n\nexport {\n  AuthenticationService,\n  buildAuthenticationRouter,\n  buildMockSsoApp,\n};\n\nexport function buildAuthenticationBackend(\n  configs: Partial<AuthenticationConfiguration>,\n  tokenGranter: TokenGranter,\n): AuthenticationBackend {\n  const service = new AuthenticationService(configs);\n  const router = buildAuthenticationRouter(service, tokenGranter);\n\n  return {\n    router,\n    service,\n  };\n}\n"],"sourceRoot":""}