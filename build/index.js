!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define("auth-backend",[],e):"object"==typeof exports?exports["auth-backend"]=e():t["auth-backend"]=e()}(global,(function(){return function(t){var e={};function r(n){if(e[n])return e[n].exports;var o=e[n]={i:n,l:!1,exports:{}};return t[n].call(o.exports,o,o.exports,r),o.l=!0,o.exports}return r.m=t,r.c=e,r.d=function(t,e,n){r.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},r.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},r.t=function(t,e){if(1&e&&(t=r(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var o in t)r.d(n,o,function(e){return t[e]}.bind(null,o));return n},r.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return r.d(e,"a",e),e},r.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r.p="",r(r.s=2)}([function(t,e){t.exports=require("node-fetch")},function(t,e){t.exports=require("express")},function(t,e,r){t.exports=r(3)},function(t,e,r){"use strict";r.r(e),r.d(e,"AuthenticationService",(function(){return s})),r.d(e,"buildAuthenticationRouter",(function(){return f})),r.d(e,"buildAuthenticationBackend",(function(){return p}));var n=r(0),o=r.n(n);async function i(t,e){const r=new URLSearchParams;r.append("id_token",e);const n=await o()(`${t.tokenInfoUrl}?${r.toString()}`);if(n.status>=500)throw new Error("validation internal error");const i=await n.json();if(200!==n.status||i.error)throw new Error(`validation error ${i.error}`);if(i.aud!==t.clientId)throw new Error("audience mismatch");return i.sub}async function a(t,e){const r=new URLSearchParams;r.append("code",e),r.append("client_id",t.clientId),r.append("client_secret",t.clientSecret);const n=await o()(t.accessTokenUrl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:r.toString()}),i=new URLSearchParams(await n.text()),a=i.get("error");if(a)throw new Error(`validation error ${a}`);const c=i.get("access_token");if(!c)throw new Error("validation internal error");const s=await o()(t.userUrl,{headers:{Authorization:`Bearer ${c}`}});return(await s.json()).id}function c(t,e,r){return e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}class s{constructor(t){c(this,"clientConfig",{}),c(this,"extractors",new Map),this.bindExtractor(t,"google",i),this.bindExtractor(t,"github",a)}supportsService(t){return this.extractors.has(t)}extractId(t,e){const r=this.extractors.get(t);if(!r)throw new Error(`Login integration with ${t} is not supported`);return r(e)}bindExtractor(t,e,r){const n=t[e];(null==n?void 0:n.clientId)&&(this.extractors.set(e,r.bind(null,n)),this.clientConfig[e]={authUrl:n.authUrl,clientId:n.clientId})}}var u=r(1),d=r.n(u);const l=d.a.json({limit:4096});function f(t,e){const r=d.a.Router();return r.get("/",(e,r)=>{r.status(200).json(t.clientConfig)}),r.post("/:name",l,async(r,n,o)=>{const{name:i}=r.params;if(!t.supportsService(i))return void o();const{externalToken:a}=r.body;if(a&&"string"==typeof a)try{const r=await t.extractId(i,a);if(!r)throw new Error("failed to get user ID");const o=e(`${i}-${r}`,i,r);n.status(200).json({userToken:o})}catch(t){"validation internal error"===t.message?n.status(500).json({error:"internal error"}):n.status(400).json({error:t.message||"unknown error"})}else n.status(400).json({error:"no externalToken provided"})}),r}function p(t,e){const r=new s(t);return{router:f(r,e),service:r}}}])}));
//# sourceMappingURL=index.js.map