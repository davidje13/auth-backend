import{createVerify as r,createSign as e,createPublicKey as n,KeyObject as t,createHmac as o,generateKeyPairSync as i,randomUUID as a}from"node:crypto";import{createServer as c}from"node:http";import{text as s}from"node:stream/consumers";const u=(r,e)=>({kid:n,key:t})=>{const i=r=>o(e,t).update(r).digest();return{alg:r,kid:n,sign:i,verify:(r,e)=>0===i(r).compare(e)}};function f(o,i){const a=({kid:r,privateKey:n})=>({alg:o,kid:r,sign:r=>e(i).update(r).sign(n)}),c=({kid:e,publicKey:a})=>({alg:o,kid:e,verify:(e,n)=>r(i).update(e).verify(a,n),toJWK:()=>{const r=(a instanceof t?a:n(a)).export({format:"jwk"});return{kty:"RSA",kid:e,alg:o,use:"sig",n:r.n,e:r.e}}});return Object.assign(r=>({...a(r),...c(r)}),{signer:a,verifier:c})}const d={alg:"none",kid:void 0,sign:()=>Buffer.from([]),verify:(r,e)=>0===e.length},l=u("HS256","sha256"),h=u("HS384","sha384"),w=u("HS512","sha512"),p=f("RS256","RSA-SHA256"),m=f("RS384","RSA-SHA384"),y=f("RS512","RSA-SHA512");function g(r){const e=i("rsa",{modulusLength:2048,privateKeyEncoding:{type:"pkcs8",format:"pem"},publicKeyEncoding:{type:"spki",format:"pem"}});return p({kid:r,...e})}function v(r){const e=[];for(const n of r)if("sig"===n.use)switch(n.alg){case"RS256":e.push(p.verifier({kid:n.kid,publicKey:{key:n,format:"jwk"}}));break;case"RS384":e.push(m.verifier({kid:n.kid,publicKey:{key:n,format:"jwk"}}));break;case"RS512":e.push(y.verifier({kid:n.kid,publicKey:{key:n,format:"jwk"}}));break;default:throw new Error(`unsupported JWK alg: ${n.alg}`)}return e}function k(r,e,n={}){const t={typ:"JWT",kid:r.kid,alg:r.alg,...n},o=`${E(t)}.${E(e)}`;return`${o}.${r.sign(o).toString("base64url")}`}function b(r,{verifyKey:e,verifyIss:n,verifyAud:t,verifyActive:o}){const i=/^([0-9a-zA-Z\-_]+)\.([0-9a-zA-Z\-_]+)\.([0-9a-zA-Z\-_]*)$/.exec(r);if(!i)throw new Error("invalid JWT");const[,a,c,s]=i,u=x(a),f=x(c);if(!1!==e&&function(r,e,n,t){let o=!1;for(const i of n)if(!(e.kid&&i.kid&&i.kid!==e.kid||i.alg!==e.alg)&&(o=!0,i.verify(r,t)))return;throw o?new Error("signature mismatch"):new Error("unknown key or algorithm")}(`${a}.${c}`,u,S(e),Buffer.from(s,"base64url")),!1!==n&&!S(n).includes(f.iss))throw new Error("issuer mismatch");if(!1!==t&&f.aud){const r=new Set(S(t));if(!S(f.aud).some(e=>r.has(e)))throw new Error("audience mismatch")}if(!1!==o){const r=!0===o?Date.now():o;if(f.nbf&&r<1e3*f.nbf)throw new Error("not yet valid");if(f.exp&&r>=1e3*f.exp)throw new Error("expired")}return{header:u,payload:f}}const E=r=>Buffer.from(JSON.stringify(r),"utf-8").toString("base64url"),x=r=>{const e=JSON.parse(Buffer.from(r,"base64url").toString("utf-8"));if(!e||"object"!=typeof e||Array.isArray(e))throw new Error("unexpected JWT content");return e},S=r=>Array.isArray(r)?r:[r];async function $(r,e){return b(e.externalToken,{verifyKey:await A(r.certsUrl),verifyIss:["accounts.google.com","https://accounts.google.com"],verifyAud:r.clientId,verifyActive:!0}).payload.sub}const T=new Map;async function A(r){const e=Date.now();let n=T.get(r);if(n&&e<n.exp)return n.verifiers;const t={exp:e+2e4,verifiers:_(r,e,2e4)};return T.set(r,t),t.verifiers}async function _(r,e,n){const t=new AbortController,o=setTimeout(()=>t.abort(),n);let i=!1;try{const n=await fetch(r,{signal:t.signal});if(n.status>=300)throw new Error("validation internal error: failed to fetch jwks");const o=await n.json();if(!o||"object"!=typeof o||Array.isArray(o))throw new Error("validation internal error: unexpected jwks structure");const a=v(o.keys),c=n.headers.get("cache-control")??"",s=/(?:^|,)\s*max-age=(\d+)\s*(?:,|$)/i.exec(c),u=s?e+1e3*Number(s[1]):0;return T.set(r,{exp:u,verifiers:a}),i=!0,a}finally{clearTimeout(o),i||T.delete(r)}}async function R(r,e){const n=new URLSearchParams;n.append("code",e.externalToken),n.append("client_id",r.clientId),n.append("client_secret",r.clientSecret);const t=await fetch(r.accessTokenUrl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:n.toString()}),o=new URLSearchParams(await t.text()),i=o.get("error");if(i)throw new Error(`validation error: ${i}`);const a=o.get("access_token");if(!a)throw new Error("validation internal error");const c=await fetch(r.userUrl,{headers:{Authorization:`Bearer ${a}`}});return(await c.json()).id}async function O(r,e){if(!e.redirectUri||!e.codeVerifier)throw new Error("validation error: missing redirect_uri or code_verifier");const n=new URLSearchParams;n.append("grant_type","authorization_code"),n.append("client_id",r.clientId),n.append("code",e.externalToken),n.append("redirect_uri",e.redirectUri),n.append("code_verifier",e.codeVerifier),n.append("code_challenge_method","S256");const t=await fetch(r.accessTokenUrl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"},body:n.toString()});if(200!==t.status)throw new Error("validation internal error");const o=await t.json();if(!o||"object"!=typeof o)throw new Error("validation internal error");const i=o.error;if(i)throw new Error(`validation error: ${i}`);const a=o.access_token;if(!a)throw new Error("validation internal error");const c=await fetch(r.tokenInfoUrl,{method:"GET",headers:{Authorization:`Bearer ${a}`}});if(c.status>=500)throw new Error("validation internal error");const s=await c.json();if(200!==c.status||s.error)throw new Error(`validation error: ${s.error}`);if(s.application.uid!==r.clientId)throw new Error("audience mismatch");return s.resource_owner_id}class j{clientConfig={};t=new Map;constructor(r){this.o(r,"google",$),this.o(r,"github",R),this.o(r,"gitlab",O)}supportsService(r){return this.t.has(r)}supportedServices(){return[...this.t.keys()]}extractId(r,e){const n=this.t.get(r);if(!n)throw new Error(`Login integration with ${r} is not supported`);return n(e)}o(r,e,n){const t=r[e];t?.clientId&&(this.t.set(e,n.bind(null,t)),this.clientConfig[e]={authUrl:t.authUrl,clientId:t.clientId})}}const P=/^([a-z0-9]+)\/?$/;function z(r,e){const n=(r,e)=>F(e,404,{}),t=t=>r.supportsService(t)?async(n,o)=>{try{const a=await async function(r,e){const n=r.headers["content-length"],t=n?Number.parseInt(n,10):e;if(t>e)throw new Error("too much data");const o=[];let i=0;for await(const e of r){if(i+=e.byteLength,i>t)throw new Error("too much data");o.push(e)}return JSON.parse(Buffer.concat(o,i).toString("utf-8"))}(n,4096);if(null===(i=a)||"object"!=typeof i)throw new Error("missing or invalid body");const{externalToken:c,redirectUri:s,codeVerifier:u}=a;if(!c||"string"!=typeof c)throw new Error("no externalToken");if(void 0!==s&&"string"!=typeof s)throw new Error("invalid redirectUri");if(void 0!==u&&"string"!=typeof u)throw new Error("invalid codeVerifier");const f=await r.extractId(t,{externalToken:c,redirectUri:s,codeVerifier:u});if(!f)throw new Error("failed to get user ID");return F(o,200,{userToken:e(`${t}-${f}`,t,f)})}catch(r){return function(r,e){return e instanceof Error&&"validation internal error"!==e.message?F(r,400,{error:e.message||"unknown error"}):F(r,500,{error:"internal error"})}(o,r)}var i}:n;return(e="")=>(n,o)=>{let i=n.url?.split("?")[0]??"";if(""!==e){if(!i.startsWith(e))return F(o,404,{});i=i.substring(e.length)}if(i.startsWith("/")&&!e.endsWith("/")&&(i=i.substring(1)),"GET"===n.method&&""===i)return((e,n)=>F(n,200,r.clientConfig))(0,o);const[,a]=P.exec(i)??[];return"POST"===n.method&&a?t(a)(n,o):F(o,""===i||a?405:404,{})}}function F(r,e,n){!function(r){r.setHeader("X-Content-Type-Options","nosniff"),r.setHeader("Cache-Control","no-cache, no-store"),r.setHeader("Expires","0"),r.setHeader("Pragma","no-cache")}(r),r.setHeader("Content-Type","application/json; charset=utf-8"),r.writeHead(e),r.write(JSON.stringify(n)),r.end()}function K(r){return r&&"string"==typeof r?r.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;"):""}function U({iss:r="https://accounts.google.com"}={}){const e=g("mock-key"),n={keys:[e.toJWK()]};return c(async(t,o)=>{const i=new URL("http://localhost"+t.url),c=new URLSearchParams(i.search);switch(`${t.method} ${i.pathname}`){case"GET /auth":return C(o,200,"text/html; charset=utf-8",(r=>`\n<!DOCTYPE html>\n<html lang="en">\n  <head>\n    <title>Mock OAuth service</title>\n    <style>\n      body {\n        background: #EEEEEE;\n        font: 1em sans-serif;\n        margin: 0;\n        padding: 0;\n      }\n      form {\n        width: 400px;\n        max-width: calc(100% - 20px);\n        box-sizing: border-box;\n        margin: 50px auto;\n        padding: 15px;\n        background: #FFFFFF;\n      }\n      h1 {\n        margin: 0 0 20px;\n        text-align: center;\n      }\n      p {\n        font-size: 0.8em;\n        margin: 20px 0;\n      }\n      input[type=text] {\n        width: 200px;\n        font-size: 0.9em;\n        padding: 4px;\n        margin: 0 10px;\n        box-sizing: border-box;\n      }\n      button {\n        font-size: 0.9em;\n        padding: 6px 12px;\n        border: none;\n        background: #008800;\n        color: #FFFFFF;\n        cursor: pointer;\n      }\n    </style>\n  </head>\n  <body>\n    <form method="POST">\n      <h1>Mock OAuth service</h1>\n      <p>\n        This is a mock implementation of an OAuth server for testing purposes.\n      </p>\n      <input type="hidden" name="redirect_uri" value="${K(r.get("redirect_uri"))}" />\n      <input type="hidden" name="nonce" value="${K(r.get("nonce"))}" />\n      <input type="hidden" name="state" value="${K(r.get("state"))}" />\n      <input type="hidden" name="client_id" value="${K(r.get("client_id"))}" />\n      <label>Sign in as <input type="text" name="identifier" required autofocus /></label><button>Sign in</button>\n    </form>\n  </body>\n</html>\n`)(c));case"POST /auth":{const n=new URLSearchParams(await s(t)),i=n.get("redirect_uri"),c=n.get("nonce"),u=n.get("state")??"",f=n.get("client_id"),d=n.get("identifier");if(!i||!f||!d)return J(o,400,{error:"missing fields"});const l=Math.floor(Date.now()/1e3),h=k(e,{iss:r,aud:f,nonce:c,jti:a(),sub:d,iat:l,exp:l+3600}),w=new URLSearchParams;return w.set("id_token",h),w.set("state",u),function(r,e,n){r.setHeader("Location",n),r.writeHead(e),r.end()}(o,303,`${i}#${w.toString()}`)}case"GET /certs":return o.setHeader("cache-control","public, max-age=0, must-revalidate, no-transform"),J(o,200,n);default:o.writeHead(404),o.end()}})}function C(r,e,n,t){r.setHeader("Content-Type",n),r.writeHead(e),r.write(t),r.end()}function J(r,e,n){C(r,e,"application/json",JSON.stringify(n))}function L(r,e){const n=new j(r);return{router:z(n,e),service:n}}export{j as AuthenticationService,l as HS256,h as HS384,w as HS512,d as NONE,p as RS256,m as RS384,y as RS512,L as buildAuthenticationBackend,z as buildAuthenticationRouter,U as buildMockSsoApp,b as decodeJWT,k as encodeJWT,v as loadJWKSVerifiers,g as makeRandomRS256};
